{% extends "applications/base.html" %}
{% block title %}Apply - Step 1{% endblock title %}

{% block content %}
<section class="container my-5">
  <h2 class="mb-4">New Student</h2>
  <form method="post" class="student-form">
    {% csrf_token %}
    <div class="mb-3">
      <label for="{{ form.fullname.id_for_label }}" class="form-label">Full Name</label>
      {{ form.fullname }}
    </div>
    <div class="mb-3">
      <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
      {{ form.email }}
    </div>
    <div class="mb-3">
      <label for="{{ form.gender.id_for_label }}" class="form-label">Gender</label>
      {{ form.gender }}
    </div>
    <div class="mb-3">
      <label for="{{ form.phone.id_for_label }}" class="form-label">Phone</label>
      {{ form.phone }}
    </div>
    <div class="mb-3">
      <label for="{{ form.course.id_for_label }}" class="form-label">Course(s)</label>
      <small class="d-block text-muted mb-1">You can select more than one course.</small>
      {{ form.course }}
    </div>
    <div class="mb-3" id="session-container" style="display: none;">
      <label for="{{ form.session.id_for_label }}" class="form-label">Session</label>
      {{ form.session }}
    </div>


    <hr>
    <h5>Home address (Tanzania)</h5>
    <div class="address-row">
      <div class="address-col">
        <label for="{{ form.region.id_for_label }}" class="form-label">Region</label>
        {{ form.region }}
      </div>
      <div class="address-col">
        <label for="{{ form.district.id_for_label }}" class="form-label">District</label>
        {{ form.district }}
      </div>
    </div>

    <button type="submit" class="btn btn-primary w-100 mt-4">Submit Application</button>
  </form>
</section>
{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function(){
  // Initialize Select2 for the course selection
  $('.select2-course').select2({
    theme: 'bootstrap-5'
  });

  // For cascading districts
  const tpl = "{% url 'apply:ajax_districts' 0 %}";
  $('#id_region').on('change', function(){
    const regionId = $(this).val();
    const $district = $('#id_district');
    $district.html('<option>Loading...</option>');
    if (!regionId) { $district.html('<option value="">Choose region first</option>'); return; }
    const url = tpl.replace('0', regionId);
    $.getJSON(url)
      .done(function(data){
        let html = '<option value="">Choose district</option>';
        if (data.districts && data.districts.length) {
          data.districts.forEach(d => html += `<option value="${d.id}">${d.name}</option>`);
        } else {
          html = '<option value="">No districts found</option>';
        }
        $district.html(html);
      })
      .fail(function(){ $district.html('<option value="">Error loading districts</option>'); });
  });

  if ($('#id_region').val()) $('#id_region').trigger('change');

  // For cascading sessions based on course
  const sessionUrlTemplate = "{% url 'apply:ajax_sessions' 0 %}";
  $('.select2-course').on('change', function(){
    const selectedCourses = $(this).val();
    const $sessionSelect = $('#id_session');
    const $sessionContainer = $('#session-container');

    // We only show sessions if ONE course is selected, to avoid confusion.
    if (!selectedCourses || selectedCourses.length !== 1) {
      $sessionContainer.hide();
      return;
    }
    const courseId = selectedCourses[0];
    const url = sessionUrlTemplate.replace('0', courseId);
    $.getJSON(url)
      .done(function(data){
        if (data.sessions && data.sessions.length) {
          let html = '<option value="">Choose session</option>';
          data.sessions.forEach(s => html += `<option value="${s.id}">${s.name}</option>`);
          $sessionSelect.html(html);
          $sessionContainer.show();
        } else {
          $sessionContainer.hide();
        }
      });
  });
});
</script>
{% endblock extra_js %}