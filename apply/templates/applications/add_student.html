{% extends "applications/base.html" %}
{% block title %}Apply - Step 1{% endblock title %}

{% block content %}
<section class="container my-5">
  <h2 class="mb-4">New Student</h2>
  <form method="post" class="student-form">
    {% csrf_token %}
    <div class="form-group-float">
      {{ form.fullname }} {{ form.fullname.label_tag }}
    </div>
    <div class="form-group-float">
      {{ form.email }} {{ form.email.label_tag }}
    </div>
    <div class="mb-3">
      {{ form.gender.label_tag }} {{ form.gender }}
    </div>
    <div class="form-group-float">
      {{ form.phone }} {{ form.phone.label_tag }}
    </div>
    <div class="mb-3">
      <label for="id_course">Course(s)</label>
      <small class="d-block text-muted mb-1">You can select more than one course.</small>
      {{ form.course }}
    </div>
    <div class="mb-3" id="session-container" style="display: none;">
      <label for="id_session">Session</label>
      <select id="id_session" name="session" class="form-select">
          <option value="">First select a course</option>
      </select>
    </div>


    <hr>
    <h5>Home address (Tanzania)</h5>
    <div class="address-row">
      <div class="address-col">
        <label for="id_region">Region</label>
        {{ form.region }}
      </div>
      <div class="address-col">
        <label for="id_district">District</label>
        {{ form.district }}
      </div>
    </div>

    <button type="submit" class="btn btn-primary">Submit</button>
  </form>
</section>
{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function(){
  // For cascading districts
  const tpl = "{% url 'apply:ajax_districts' 0 %}";
  $('#id_region').on('change', function(){
    const regionId = $(this).val();
    const $district = $('#id_district');
    $district.html('<option>Loading...</option>');
    if (!regionId) { $district.html('<option value="">Choose region first</option>'); return; }
    const url = tpl.replace('0', regionId);
    $.getJSON(url)
      .done(function(data){
        let html = '<option value="">Choose district</option>';
        if (data.districts && data.districts.length) {
          data.districts.forEach(d => html += `<option value="${d.id}">${d.name}</option>`);
        } else {
          html = '<option value="">No districts found</option>';
        }
        $district.html(html);
      })
      .fail(function(){ $district.html('<option value="">Error loading districts</option>'); });
  });

  if ($('#id_region').val()) $('#id_region').trigger('change');

  // For cascading sessions based on course
  const sessionUrlTemplate = "{% url 'apply:ajax_sessions' 0 %}";
  $('#id_course').on('change', function(){
    const courseId = $(this).val();
    const $sessionSelect = $('#id_session');
    const $sessionContainer = $('#session-container');

    if (!courseId) {
      $sessionContainer.hide();
      return;
    }

    const url = sessionUrlTemplate.replace('0', courseId);
    $.getJSON(url)
      .done(function(data){
        if (data.sessions && data.sessions.length) {
          let html = '<option value="">Choose session</option>';
          data.sessions.forEach(s => html += `<option value="${s.id}">${s.name}</option>`);
          $sessionSelect.html(html);
          $sessionContainer.show();
        } else {
          $sessionContainer.hide();
        }
      });
  });
});
</script>
{% endblock extra_js %}