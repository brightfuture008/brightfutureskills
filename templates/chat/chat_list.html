{% extends "applications/base.html" %}

{% block content %}
<div class="container mt-5">
    <h2>Select a Conversation</h2>
    <div class="list-group mt-3">
        {% for contact in contacts %}
        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <a href="{% url 'chat:chat_with' contact.id %}" class="text-decoration-none text-reset flex-grow-1">
                {% if request.user.is_staff %}{{ contact.username }}{% else %}Admin{% endif %}
                {% if contact.is_superuser %} <span class="badge bg-primary rounded-pill">Admin</span> {% endif %}
            </a>
            <button class="btn btn-sm btn-outline-secondary mark-unread-btn" data-user-id="{{ contact.id }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Mark as unread">
                <i class="bi bi-envelope"></i>
            </button>
        </div>
        {% empty %}
        <p class="text-muted">No conversations found.</p>
        {% endfor %}
    </div>
</div>

<script>
document.querySelectorAll('.mark-unread-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const userId = this.dataset.userId;
        fetch("{% url 'chat:chat_list' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({action: 'mark_unread', target_user_id: userId})
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'ok') {
                // Optional: Show feedback or update UI immediately
                alert('Conversation marked as unread');
                // Trigger the global unread count update if it exists
                if (typeof updateUnreadCount === 'function') updateUnreadCount();
            }
        });
    });
});
</script>
{% endblock %}