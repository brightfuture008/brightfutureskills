{% extends "applications/base.html" %}

{% block title %}Apply for Courses{% endblock %}

{% block content %}
<section class="container my-5">
    <form method="post" class="student-form" novalidate>
        <h2 class="mb-4 text-center">Student Application Form</h2>
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <div class="mb-3">
            <label for="{{ form.fullname.id_for_label }}" class="form-label">Full Name</label>
            {{ form.fullname }}
            {% if form.fullname.errors %}<div class="text-danger small mt-1">{{ form.fullname.errors|striptags }}</div>{% endif %}
        </div>
        <div class="mb-3">
            <label for="{{ form.email.id_for_label }}" class="form-label">Email Address</label>
            {{ form.email }}
            {% if form.email.errors %}<div class="text-danger small mt-1">{{ form.email.errors|striptags }}</div>{% endif %}
        </div>
        <div class="mb-3">
            <label for="{{ form.phone.id_for_label }}" class="form-label">Phone Number</label>
            {{ form.phone }}
            {% if form.phone.errors %}<div class="text-danger small mt-1">{{ form.phone.errors|striptags }}</div>{% endif %}
        </div>
        <div class="mb-3">
            <label for="{{ form.gender.id_for_label }}" class="form-label">Gender</label>
            {{ form.gender }}
            {% if form.gender.errors %}<div class="text-danger small mt-1">{{ form.gender.errors|striptags }}</div>{% endif %}
        </div>
        <hr class="my-4">
        <div class="mb-3">
            <label for="{{ form.region.id_for_label }}" class="form-label">Home Region</label>
            {{ form.region }}
            {% if form.region.errors %}<div class="text-danger small mt-1">{{ form.region.errors|striptags }}</div>{% endif %}
        </div>
        <div class="mb-3">
            <label for="{{ form.district.id_for_label }}" class="form-label">Home District</label>
            {{ form.district }}
            {% if form.district.errors %}<div class="text-danger small mt-1">{{ form.district.errors|striptags }}</div>{% endif %}
        </div>
        <hr class="my-4">
        <div class="mb-3">
            <h5>First Course Choice</h5>
            <label for="course1" class="form-label">Course</label>
            <select name="course1" id="course1" class="form-select dynamic-course" required>
                <option value="">---------</option>
                {% for course in courses %}<option value="{{ course.id }}">{{ course.title }}</option>{% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="session1" class="form-label">Session</label>
            <select name="session1" id="session1" class="form-select" disabled required>
                <option value="">Select a course first</option>
            </select>
        </div>
        <hr class="my-4">
        <div class="mb-3">
            <h5>Second Course Choice (Optional)</h5>
            <label for="course2" class="form-label">Course</label>
            <select name="course2" id="course2" class="form-select dynamic-course">
                <option value="">---------</option>
                {% for course in courses %}<option value="{{ course.id }}">{{ course.title }}</option>{% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="session2" class="form-label">Session</label>
            <select name="session2" id="session2" class="form-select" disabled>
                <option value="">Select a course first</option>
            </select>
        </div>




        <button type="submit" class="btn btn-primary w-100 mt-3">Submit Application</button>
    </form>
</section>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const regionSelect = $("#{{ form.region.id_for_label }}");
    const districtSelect = $("#{{ form.district.id_for_label }}");
    const districtUrl = "{% url 'apply:ajax_districts' 0 %}".replace('0/', ''); // Correctly create the base URL

    regionSelect.on('change', function() {
        const regionId = $(this).val();
        if (regionId) {
            $.ajax({
                url: districtUrl + regionId + '/',
                success: function(data) {
                    districtSelect.empty(); // Clear old options
                    districtSelect.append('<option value="">---------</option>'); // Add a placeholder
                    data.districts.forEach(function(district) {
                        districtSelect.append(`<option value="${district.id}">${district.name}</option>`);
                    });
                    districtSelect.prop('disabled', false);
                }
            });
        } else {
            districtSelect.empty().append('<option value="">Select a region first</option>').prop('disabled', true);
        }
    });

    if (regionSelect.val()) {
        regionSelect.trigger('change');
    }

    // --- Dynamic Sessions Logic ---
    const sessionUrl = "{% url 'apply:ajax_sessions' 0 %}".replace('0/', '');

    $('.dynamic-course').on('change', function() {
        const courseSelect = $(this);
        const courseId = courseSelect.val();
        const sessionSelectId = courseSelect.attr('id').replace('course', 'session');
        const sessionSelect = $('#' + sessionSelectId);

        if (courseId) {
            $.ajax({
                url: sessionUrl + courseId + '/',
                success: function(data) {
                    sessionSelect.empty().append('<option value="">---------</option>');
                    if (data.sessions.length > 0) {
                        data.sessions.forEach(function(session) {
                            sessionSelect.append(`<option value="${session.id}">${session.name}</option>`);
                        });
                        sessionSelect.prop('disabled', false);
                    } else {
                        sessionSelect.append('<option value="">No sessions available</option>').prop('disabled', true);
                    }
                }
            });
        } else {
            sessionSelect.empty().append('<option value="">Select a course first</option>').prop('disabled', true);
        }
    });
});
</script>
{% endblock extra_js %}