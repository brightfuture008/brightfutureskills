<div class="mt-5 p-4 bg-theme-card rounded shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Course Comments</h3>
        <div class="text-end">
            <div class="h4 mb-0 text-warning">
                {{ avg_rating|floatformat:1 }} <i class="bi bi-star-fill"></i>
            </div>
            <small class="text-muted">Average Rating</small>
        </div>
    </div>
    
    <div class="mb-4">
        {% for comment in course.comments.all %}
            <div class="d-flex mb-3 border-bottom pb-3">
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mt-0 mb-1">{{ comment.user.username }} <small class="text-muted" style="font-size: 0.8rem;">{{ comment.created_at|date:"M d, Y" }}</small></h5>
                        <div class="rating-stars">
                            {% for i in "12345"|make_list %}
                                {% if forloop.counter <= comment.rating %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                {% else %}
                                    <i class="bi bi-star text-muted"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {{ comment.content }}
                    
                    <div class="mt-2">
                        {% if user == comment.user %}
                            <a href="{% url 'chat:update_comment' comment.id %}" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit"><i class="bi bi-pencil-square"></i></a>
                        {% endif %}
                        
                        {% if user == comment.user or user.is_staff %}
                            <form action="{% url 'chat:delete_comment' comment.id %}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete"><i class="bi bi-trash"></i></button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <p class="text-muted">No comments yet. Be the first to share your thoughts!</p>
        {% endfor %}
    </div>
    
    {% if user.is_authenticated %}
        <form action="{% url 'chat:add_comment' course.id %}" method="post">
            {% csrf_token %}
            <div class="mb-2">
                <label class="form-label fw-bold">Rate this course:</label>
                <div class="rating-input">
                    <i class="bi bi-star-fill active" data-value="1"></i>
                    <i class="bi bi-star-fill active" data-value="2"></i>
                    <i class="bi bi-star-fill active" data-value="3"></i>
                    <i class="bi bi-star-fill active" data-value="4"></i>
                    <i class="bi bi-star-fill active" data-value="5"></i>
                </div>
                <input type="hidden" name="rating" id="rating-input" value="5">
            </div>
            <div class="mb-3">
                <textarea name="content" class="form-control" rows="3" placeholder="Write a comment..." required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Post Comment</button>
        </form>
        <script>
            document.querySelectorAll('.rating-input i').forEach(star => {
                star.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    document.getElementById('rating-input').value = value;
                    document.querySelectorAll('.rating-input i').forEach(s => {
                        if (s.getAttribute('data-value') <= value) {
                            s.classList.add('active');
                            s.classList.remove('text-muted');
                        } else {
                            s.classList.remove('active');
                            s.classList.add('text-muted');
                        }
                    });
                });
            });
        </script>
    {% else %}
        <p><a href="{% url 'users:login' %}">Login</a> to post comments.</p>
    {% endif %}
</div>